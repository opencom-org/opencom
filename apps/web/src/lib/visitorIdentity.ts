type VisitorIdentityInput = {
  visitorId?: string | null;
  readableId?: string | null;
  name?: string | null;
  email?: string | null;
};

type HumanIdVariant = "numbered" | "verb";

/**
 * Human-readable visitor IDs are deterministically derived from `visitorId`.
 *
 * Rationale:
 * - Same input (`visitorId`) always yields the same label everywhere.
 * - Backend persists this value as `visitors.readableId` for admin/debug lookup.
 * - UI can still derive a fallback from `visitorId` when persisted data is absent.
 *
 * Stability contract:
 * - `formatHumanVisitorId` must remain deterministic for a given `visitorId`.
 * - The order of these word lists affects outputs. Treat lists as append-only
 *   unless remapping historical labels is explicitly acceptable.
 */

const HUMAN_ID_ADJECTIVES = [
  "afraid",
  "all",
  "beige",
  "better",
  "big",
  "blue",
  "bold",
  "brave",
  "breezy",
  "bright",
  "brown",
  "bumpy",
  "busy",
  "calm",
  "chatty",
  "chilly",
  "chubby",
  "clean",
  "clear",
  "clever",
  "cold",
  "common",
  "cool",
  "cozy",
  "crisp",
  "cuddly",
  "curly",
  "curvy",
  "cute",
  "cyan",
  "dark",
  "deep",
  "dirty",
  "dry",
  "dull",
  "eager",
  "early",
  "easy",
  "eight",
  "eighty",
  "eleven",
  "empty",
  "every",
  "fair",
  "famous",
  "fancy",
  "fast",
  "few",
  "fiery",
  "fifty",
  "fine",
  "five",
  "flat",
  "floppy",
  "fluffy",
  "forty",
  "four",
  "frank",
  "free",
  "fresh",
  "fruity",
  "full",
  "funky",
  "funny",
  "fuzzy",
  "gentle",
  "giant",
  "gold",
  "good",
  "goofy",
  "great",
  "green",
  "grumpy",
  "happy",
  "heavy",
  "hip",
  "honest",
  "hot",
  "huge",
  "humble",
  "hungry",
  "icy",
  "itchy",
  "jolly",
  "khaki",
  "kind",
  "large",
  "late",
  "lazy",
  "legal",
  "lemon",
  "light",
  "little",
  "long",
  "loose",
  "loud",
  "lovely",
  "lucky",
  "major",
  "many",
  "metal",
  "mighty",
  "modern",
  "moody",
  "neat",
  "new",
  "nice",
  "nine",
  "ninety",
  "odd",
  "old",
  "olive",
  "open",
  "orange",
  "perky",
  "petite",
  "pink",
  "plain",
  "plenty",
  "polite",
  "pretty",
  "proud",
  "public",
  "puny",
  "purple",
  "quick",
  "quiet",
  "rare",
  "ready",
  "real",
  "red",
  "rich",
  "ripe",
  "salty",
  "seven",
  "shaggy",
  "shaky",
  "sharp",
  "shiny",
  "short",
  "shy",
  "silent",
  "silly",
  "silver",
  "six",
  "sixty",
  "slick",
  "slimy",
  "slow",
  "small",
  "smart",
  "smooth",
  "social",
  "soft",
  "solid",
  "some",
  "sour",
  "sparkly",
  "spicy",
  "spotty",
  "stale",
  "strict",
  "strong",
  "sunny",
  "sweet",
  "swift",
  "tall",
  "tame",
  "tangy",
  "tasty",
  "ten",
  "tender",
  "thick",
  "thin",
  "thirty",
  "three",
  "tidy",
  "tiny",
  "tired",
  "tough",
  "tricky",
  "true",
  "twelve",
  "twenty",
  "two",
  "upset",
  "vast",
  "violet",
  "wacky",
  "warm",
  "wet",
  "whole",
  "wicked",
  "wide",
  "wild",
  "wise",
  "witty",
  "yellow",
  "young",
  "yummy",
] as const;

const HUMAN_ID_NOUNS = [
  "actors",
  "ads",
  "adults",
  "aliens",
  "animals",
  "ants",
  "apes",
  "apples",
  "areas",
  "baboons",
  "badgers",
  "bags",
  "balloons",
  "bananas",
  "banks",
  "bars",
  "baths",
  "bats",
  "beans",
  "bears",
  "beds",
  "beers",
  "bees",
  "berries",
  "bikes",
  "birds",
  "boats",
  "bobcats",
  "books",
  "bottles",
  "boxes",
  "breads",
  "brooms",
  "buckets",
  "bugs",
  "buses",
  "bushes",
  "buttons",
  "camels",
  "cameras",
  "candies",
  "candles",
  "canyons",
  "carpets",
  "carrots",
  "cars",
  "cases",
  "cats",
  "chairs",
  "chefs",
  "chicken",
  "cities",
  "clocks",
  "cloths",
  "clouds",
  "clowns",
  "clubs",
  "coats",
  "cobras",
  "coins",
  "colts",
  "comics",
  "cooks",
  "corners",
  "cougars",
  "cows",
  "crabs",
  "crews",
  "cups",
  "cycles",
  "dancers",
  "days",
  "deer",
  "deserts",
  "dingos",
  "dodos",
  "dogs",
  "dolls",
  "donkeys",
  "donuts",
  "doodles",
  "doors",
  "dots",
  "dragons",
  "drinks",
  "dryers",
  "ducks",
  "eagles",
  "ears",
  "eels",
  "eggs",
  "emus",
  "ends",
  "experts",
  "eyes",
  "facts",
  "falcons",
  "fans",
  "feet",
  "files",
  "flies",
  "flowers",
  "forks",
  "foxes",
  "friends",
  "frogs",
  "games",
  "garlics",
  "geckos",
  "geese",
  "ghosts",
  "gifts",
  "glasses",
  "goats",
  "grapes",
  "groups",
  "guests",
  "hairs",
  "hands",
  "hats",
  "heads",
  "hoops",
  "hornets",
  "horses",
  "hotels",
  "hounds",
  "houses",
  "humans",
  "icons",
  "ideas",
  "impalas",
  "insects",
  "islands",
  "items",
  "jars",
  "jeans",
  "jobs",
  "jokes",
  "keys",
  "kids",
  "kings",
  "kiwis",
  "knives",
  "lamps",
  "lands",
  "laws",
  "lemons",
  "lies",
  "lights",
  "lilies",
  "lines",
  "lions",
  "lizards",
  "llamas",
  "loops",
  "mails",
  "mammals",
  "mangos",
  "maps",
  "masks",
  "meals",
  "melons",
  "memes",
  "meteors",
  "mice",
  "mirrors",
  "moles",
  "moments",
  "monkeys",
  "months",
  "moons",
  "moose",
  "mugs",
  "nails",
  "needles",
  "news",
  "nights",
  "numbers",
  "olives",
  "onions",
  "oranges",
  "otters",
  "owls",
  "pandas",
  "pans",
  "pants",
  "papayas",
  "papers",
  "parents",
  "parks",
  "parrots",
  "parts",
  "paths",
  "paws",
  "peaches",
  "pears",
  "peas",
  "pens",
  "pets",
  "phones",
  "pianos",
  "pigs",
  "pillows",
  "places",
  "planes",
  "planets",
  "plants",
  "plums",
  "poems",
  "poets",
  "points",
  "pots",
  "pugs",
  "pumas",
  "queens",
  "rabbits",
  "radios",
  "rats",
  "ravens",
  "readers",
  "regions",
  "results",
  "rice",
  "rings",
  "rivers",
  "rockets",
  "rocks",
  "rooms",
  "roses",
  "rules",
  "sails",
  "schools",
  "seals",
  "seas",
  "sheep",
  "shirts",
  "shoes",
  "showers",
  "shrimps",
  "sides",
  "signs",
  "singers",
  "sites",
  "sloths",
  "snails",
  "snakes",
  "socks",
  "spiders",
  "spies",
  "spoons",
  "squids",
  "stamps",
  "stars",
  "states",
  "steaks",
  "streets",
  "suits",
  "suns",
  "swans",
  "symbols",
  "tables",
  "taxes",
  "taxis",
  "teams",
  "teeth",
  "terms",
  "things",
  "ties",
  "tigers",
  "times",
  "tips",
  "tires",
  "toes",
  "tools",
  "towns",
  "toys",
  "trains",
  "trams",
  "trees",
  "turkeys",
  "turtles",
  "vans",
  "views",
  "walls",
  "wasps",
  "waves",
  "ways",
  "webs",
  "weeks",
  "windows",
  "wings",
  "wolves",
  "wombats",
  "words",
  "worlds",
  "worms",
  "yaks",
  "years",
  "zebras",
  "zoos",
] as const;

const HUMAN_ID_VERBS = [
  "accept",
  "act",
  "add",
  "admire",
  "agree",
  "allow",
  "appear",
  "argue",
  "arrive",
  "ask",
  "attack",
  "attend",
  "bake",
  "bathe",
  "battle",
  "beam",
  "beg",
  "begin",
  "behave",
  "bet",
  "boil",
  "bow",
  "brake",
  "brush",
  "build",
  "burn",
  "buy",
  "call",
  "camp",
  "care",
  "carry",
  "change",
  "cheat",
  "check",
  "cheer",
  "chew",
  "clap",
  "clean",
  "cough",
  "count",
  "cover",
  "crash",
  "create",
  "cross",
  "cry",
  "cut",
  "dance",
  "decide",
  "deny",
  "design",
  "dig",
  "divide",
  "do",
  "double",
  "doubt",
  "draw",
  "dream",
  "dress",
  "drive",
  "drop",
  "drum",
  "eat",
  "end",
  "enjoy",
  "enter",
  "exist",
  "fail",
  "fall",
  "feel",
  "fetch",
  "film",
  "find",
  "fix",
  "flash",
  "float",
  "flow",
  "fly",
  "fold",
  "follow",
  "fry",
  "give",
  "glow",
  "go",
  "grab",
  "greet",
  "grin",
  "grow",
  "guess",
  "hammer",
  "hang",
  "happen",
  "heal",
  "hear",
  "help",
  "hide",
  "hope",
  "hug",
  "hunt",
  "invent",
  "invite",
  "itch",
  "jam",
  "jog",
  "join",
  "joke",
  "judge",
  "juggle",
  "jump",
  "kick",
  "kiss",
  "kneel",
  "knock",
  "know",
  "laugh",
  "lay",
  "lead",
  "learn",
  "leave",
  "lick",
  "lie",
  "like",
  "listen",
  "live",
  "look",
  "lose",
  "love",
  "make",
  "march",
  "marry",
  "mate",
  "matter",
  "melt",
  "mix",
  "move",
  "nail",
  "notice",
  "obey",
  "occur",
  "open",
  "own",
  "pay",
  "peel",
  "pick",
  "play",
  "poke",
  "post",
  "press",
  "prove",
  "pull",
  "pump",
  "punch",
  "push",
  "raise",
  "read",
  "refuse",
  "relate",
  "relax",
  "remain",
  "repair",
  "repeat",
  "reply",
  "report",
  "rescue",
  "rest",
  "retire",
  "return",
  "rhyme",
  "ring",
  "roll",
  "rule",
  "run",
  "rush",
  "say",
  "scream",
  "search",
  "see",
  "sell",
  "send",
  "serve",
  "shake",
  "share",
  "shave",
  "shine",
  "shop",
  "shout",
  "show",
  "sin",
  "sing",
  "sink",
  "sip",
  "sit",
  "sleep",
  "slide",
  "smash",
  "smell",
  "smile",
  "smoke",
  "sneeze",
  "sniff",
  "sort",
  "speak",
  "spend",
  "stand",
  "stare",
  "start",
  "stay",
  "stick",
  "stop",
  "strive",
  "study",
  "swim",
  "switch",
  "take",
  "talk",
  "tan",
  "tap",
  "taste",
  "teach",
  "tease",
  "tell",
  "thank",
  "think",
  "throw",
  "tickle",
  "tie",
  "trade",
  "train",
  "travel",
  "try",
  "turn",
  "type",
  "unite",
  "vanish",
  "visit",
  "wait",
  "walk",
  "warn",
  "wash",
  "watch",
  "wave",
  "wear",
  "win",
  "wink",
  "wish",
  "wonder",
  "work",
  "worry",
  "write",
  "yawn",
  "yell",
] as const;

function normalizeIdentityField(value?: string | null): string | null {
  const normalized = value?.trim();
  return normalized && normalized.length > 0 ? normalized : null;
}

function hashString(value: string): number {
  let hash = 2166136261;
  for (let index = 0; index < value.length; index += 1) {
    hash ^= value.charCodeAt(index);
    hash = Math.imul(hash, 16777619);
  }
  return hash >>> 0;
}

function pickWord(words: readonly string[], hash: number, salt: number): string {
  const mixed = Math.imul(hash ^ salt, 2246822519) >>> 0;
  return words[mixed % words.length] ?? words[0] ?? "visitor";
}

export function formatHumanVisitorId(
  visitorId: string,
  variant: HumanIdVariant = "numbered"
): string {
  // Deterministic hash + indexed dictionary lookup keeps labels stable across surfaces.
  const hash = hashString(visitorId);
  const adjective = pickWord(HUMAN_ID_ADJECTIVES, hash, 0x9e3779b9);
  const noun = pickWord(HUMAN_ID_NOUNS, hash, 0x85ebca6b);

  if (variant === "verb") {
    const verb = pickWord(HUMAN_ID_VERBS, hash, 0xc2b2ae35);
    return `${adjective}-${noun}-${verb}`;
  }

  const numericSeed = Math.imul(hash ^ 0x27d4eb2d, 0x165667b1) >>> 0;
  const suffix = String((numericSeed % 99) + 1).padStart(2, "0");
  return `${adjective}-${noun}-${suffix}`;
}

export function formatVisitorIdentityLabel(input: VisitorIdentityInput): string {
  const name = normalizeIdentityField(input.name);
  if (name) {
    return name;
  }

  const email = normalizeIdentityField(input.email);
  if (email) {
    return email;
  }

  const readableId = normalizeIdentityField(input.readableId);
  if (readableId) {
    return readableId;
  }

  const visitorId = normalizeIdentityField(input.visitorId);
  if (visitorId) {
    return formatHumanVisitorId(visitorId);
  }

  return "Unknown visitor";
}

export function formatVisitorEmailLabel(
  input: Pick<VisitorIdentityInput, "email" | "readableId" | "visitorId">
): string {
  const email = normalizeIdentityField(input.email);
  if (email) {
    return email;
  }

  const readableId = normalizeIdentityField(input.readableId);
  if (readableId) {
    return readableId;
  }

  const visitorId = normalizeIdentityField(input.visitorId);
  if (visitorId) {
    return formatHumanVisitorId(visitorId);
  }

  return "Unknown email";
}
